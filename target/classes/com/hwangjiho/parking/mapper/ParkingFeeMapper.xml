<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hwangjiho.parking.mapper.ParkingFeeMapper">

	<!-- 공통 resultMap: DTO(com.hwangjiho.parking.service.dto.ParkingFeeRow)와 
		컬럼명 매칭 -->
	<resultMap id="ParkingFeeRowMap"
		type="com.hwangjiho.parking.service.dto.ParkingFeeRow">
		<id property="feeId" column="FEE_ID" />
		<result property="vehicleId" column="VEHICLE_ID" />
		<result property="entryAt" column="ENTRY_AT" />     <!-- TIMESTAMP -->
		<result property="exitAt" column="EXIT_AT" />      <!-- TIMESTAMP -->
		<result property="useMinutes" column="USE_MINUTES" />
		<result property="freeMinutes" column="FREE_MINUTES" />
		<result property="totalFee" column="TOTAL_FEE" />
	</resultMap>

	<!-- A) 입고행 없으면 생성 - VEHICLE_ENTRY.ENTRY_AT을 최초 ENTRY_AT으로 복사 - EXIT_AT은 
		NULL(미정산) -->
	<insert id="insertEntryIfAbsent">
		INSERT INTO PARKING_FEE_INFO (FEE_ID, VEHICLE_ID, ENTRY_AT)
		SELECT SEQ_PARKING_FEE.NEXTVAL, v.ID, v.ENTRY_AT
		FROM VEHICLE_ENTRY v
		WHERE v.ID = #{carId}
		AND NOT EXISTS (
		SELECT 1
		FROM PARKING_FEE_INFO p
		WHERE p.VEHICLE_ID = v.ID
		AND p.EXIT_AT IS NULL -- 아직 정산 안 끝난 건이 있으면 새로 만들지 않음
		)
	</insert>

	<!-- B) 출고시간/이용분 업데이트(미정산 건만) - USE_MINUTES = round( (now - entry) * 24 
		* 60 ) - ENTRY_AT/EXIT_AT이 TIMESTAMP인 전제에서, DATE로 캐스팅하여 분 차이 계산 -->
	<update id="updateExitAndUseMinutes">
		UPDATE PARKING_FEE_INFO
		SET EXIT_AT = SYSTIMESTAMP,
		USE_MINUTES =
		GREATEST(
		ROUND(
		(CAST(SYSTIMESTAMP AS DATE) - CAST(ENTRY_AT AS DATE)) * 24 * 60
		),
		0
		)
		WHERE VEHICLE_ID = #{carId}
		AND EXIT_AT IS NULL
	</update>

	<!-- C) 최신 행 조회(해당 차량의 가장 최근 FEE_ID) - 11g 호환: 서브쿼리 MAX(FEE_ID) 사용 - ENTRY_AT/EXIT_AT은 
		TIMESTAMP로 반환되도록 CAST 유지(선택) -->
	<select id="selectLatestRow" resultMap="ParkingFeeRowMap">
		SELECT
		p.FEE_ID,
		p.VEHICLE_ID,
		/* 필요 시 CAST 유지, TIMESTAMP 컬럼이면 생략해도 무방 */
		CAST(p.ENTRY_AT AS TIMESTAMP) AS ENTRY_AT,
		CAST(p.EXIT_AT AS TIMESTAMP) AS EXIT_AT,
		p.USE_MINUTES,
		p.FREE_MINUTES,
		p.TOTAL_FEE
		FROM PARKING_FEE_INFO p
		WHERE p.VEHICLE_ID = #{carId}
		AND p.FEE_ID = (
		SELECT MAX(pp.FEE_ID)
		FROM PARKING_FEE_INFO pp
		WHERE pp.VEHICLE_ID = #{carId}
		)
	</select>

	<!-- D) 무료분 업데이트(최신 행) -->
	<update id="updateFreeMinutes">
		UPDATE PARKING_FEE_INFO
		SET FREE_MINUTES = #{freeMinutes}
		WHERE VEHICLE_ID = #{carId}
		AND FEE_ID = (
		SELECT MAX(pp.FEE_ID)
		FROM PARKING_FEE_INFO pp
		WHERE pp.VEHICLE_ID = #{carId}
		)
	</update>

	<!-- E) 최종요금 업데이트(최신 행) -->
	<update id="updateTotalFee">
		UPDATE PARKING_FEE_INFO
		SET TOTAL_FEE = #{totalFee}
		WHERE VEHICLE_ID = #{carId}
		AND FEE_ID = (
		SELECT MAX(pp.FEE_ID)
		FROM PARKING_FEE_INFO pp
		WHERE pp.VEHICLE_ID = #{carId}
		)
	</update>

</mapper>
