<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>äº‹å‰ç²¾ç®—ï½œç²¾ç®—æ–¹æ³•é¸æŠ</title>
<style>
:root {
	--bg: #fdf5e6;
	--panel: #fffaf0;
	--text: #444;
	--line: #d8c49b;
	--accent: #d6b85a;
	--hover: #f8efd0;
	--muted: #666;
}

* {
	box-sizing: border-box
}

html, body {
	height: 100%;
	margin: 0;
	padding: 0
}

body {
	background: var(--bg);
	color: var(--text);
	font-family: 'Noto Sans JP', 'Malgun Gothic', sans-serif;
	display: flex;
	flex-direction: column
}

/* Topbar */
.topbar {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 12px 20px;
	background: var(--panel);
	border-bottom: 2px solid var(--line)
}

.title {
	font-weight: 800;
	text-align: center;
	flex: 1
}

.actions, .actions-left {
	display: flex;
	gap: 10px;
	align-items: center
}

.link-btn {
	border: 2px solid var(--line);
	border-radius: 12px;
	background: var(--bg);
	color: var(--text);
	font-weight: 700;
	cursor: pointer;
	padding: 10px 16px;
	font-size: 16px
}

.link-btn:hover {
	background: var(--hover)
}

/* Layout 1:1 */
.main-wrap {
	flex: 1;
	display: grid;
	gap: 18px;
	padding: 18px;
	grid-template-columns: 1fr 1fr
}

@media ( max-width :980px) {
	.main-wrap {
		grid-template-columns: 1fr
	}
}

.card {
	background: var(--panel);
	border: 2px solid var(--line);
	border-radius: 16px;
	padding: 22px;
	box-shadow: 0 5px 12px rgba(0, 0, 0, .08)
}

/* Left */
.left-box {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 16px
}

.left-box h2 {
	margin: 0 0 8px;
	font-size: clamp(22px, 2.6vw, 30px);
	font-weight: 900;
	letter-spacing: .02em
}

.toggle-row {
	display: flex;
	gap: 12px;
	justify-content: center;
	flex-wrap: wrap
}

.toggle-btn {
	border: 2px solid var(--line);
	border-radius: 14px;
	background: var(--bg);
	color: #222;
	font-weight: 900;
	padding: 14px 20px;
	font-size: clamp(16px, 2vw, 22px);
	cursor: pointer;
	min-width: 150px
}

.toggle-btn.active {
	background: var(--accent);
	color: #222;
	box-shadow: 0 4px 10px rgba(0, 0, 0, .08)
}

.ticket-box {
	background: #fff;
	border: 2px dashed var(--line);
	border-radius: 16px;
	width: min(96%, 760px);
	min-height: 160px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: clamp(16px, 2vw, 22px);
	color: var(--muted);
	text-align: center;
	padding: 14px
}

#spendArea {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	width: 100%;
	gap: 10px
}

.ticket-input {
	font-size: clamp(18px, 2.2vw, 24px);
	padding: 12px;
	width: min(96%, 520px);
	border: 2px solid var(--line);
	border-radius: 12px;
	text-align: right
}

.ticket-input:disabled {
	background: #f2f2f2;
	color: #999;
	cursor: not-allowed
}

.input-hint {
	font-size: clamp(14px, 1.6vw, 16px);
	color: var(--muted)
}

.action-row {
	display: flex;
	gap: 10px;
	justify-content: center;
	margin-top: 4px
}

.apply-btn {
	border: 0;
	border-radius: 14px;
	background: var(--accent);
	padding: 14px 24px;
	font-weight: 900;
	cursor: pointer;
	font-size: clamp(18px, 2.4vw, 26px);
	box-shadow: 0 5px 14px rgba(0, 0, 0, .15)
}

.apply-btn:active {
	transform: translateY(1px)
}

/* Right */
.fee-box {
	font-size: 18px;
	line-height: 1.8;
	border: 2px solid var(--line);
	border-radius: 16px;
	background: #fff;
	padding: 18px
}

.fee-box .row {
	display: flex;
	justify-content: space-between;
	gap: 10px
}

.fee-box .label {
	color: var(--muted)
}

.fee-box .value {
	font-weight: 800
}

.fee-grid {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 12px;
	margin-top: 10px
}

.fee-item {
	border: 2px solid var(--line);
	border-radius: 14px;
	padding: 14px;
	background: #fff
}

.fee-item h4 {
	margin: 0 0 6px;
	font-size: 16px
}

.amount {
	font-weight: 900;
	font-size: clamp(22px, 2.6vw, 28px)
}

.amount.small {
	font-size: clamp(18px, 2.2vw, 22px)
}

.strike {
	text-decoration: line-through;
	color: #999;
	margin-right: 8px
}

.cap-note {
	color: var(--muted);
	font-size: 14px;
	margin-top: 6px;
	text-align: right
}

.note {
	margin-top: 10px;
	color: var(--muted);
	text-align: center;
	font-size: 14px
}

.pay-grid {
	display: none;
	gap: 16px;
	justify-content: center;
	margin-top: 18px
}

.pay-btn {
	width: 190px;
	padding: 18px 0;
	font-size: 21px;
	font-weight: 900;
	border-radius: 12px;
	border: 2px solid var(--line);
	cursor: pointer
}

.pay-btn--cash {
	background: #ffe4b5
}

.pay-btn--card {
	background: #e6d690
}

/* ë¬´ë£Œ ìë™ ì´ë™ ì•ˆë‚´ ì˜¤ë²„ë ˆì´ */
.free-overlay {
	position: fixed;
	inset: 0;
	display: none;
	align-items: center;
	justify-content: center;
	background: rgba(0, 0, 0, .35);
	z-index: 9999;
}

.free-panel {
	background: var(--panel);
	border: 2px solid var(--line);
	border-radius: 16px;
	padding: 24px 28px;
	box-shadow: 0 8px 20px rgba(0, 0, 0, .2);
	text-align: center;
	max-width: 520px;
	width: 90%;
}

.free-panel .msg {
	font-size: clamp(18px, 2.4vw, 26px);
	font-weight: 900;
	margin: 0 0 10px;
}

.free-panel .sub {
	font-size: clamp(14px, 1.8vw, 18px);
	color: var(--muted);
	margin: 0;
}

.spinner {
	width: 52px;
	height: 52px;
	border-radius: 50%;
	border: 6px solid #eadfca;
	border-top-color: var(--accent);
	animation: spin 1s linear infinite;
	margin: 14px auto
}

@keyframes spin {
	to {transform: rotate(360deg)
}
}
</style>
</head>

<body>
	<div class="topbar">
		<div class="actions-left">
			<a href="/kiosk/step1" class="link-btn" id="btnHome">ğŸ  ãƒ›ãƒ¼ãƒ </a> <a
				href="javascript:void(0)" class="link-btn" id="btnBack">â† æˆ»ã‚‹</a>
		</div>
		<div class="title">ã”åˆ©ç”¨æ–™é‡‘ã®ç²¾ç®—</div>
		<div class="actions">
			<button class="link-btn" id="btnLang">English</button>
		</div>
	</div>

	<main class="main-wrap">
		<!-- Left: ì„œë¹„ìŠ¤ ë“±ë¡ -->
		<section class="card left-box">
			<h2>ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h2>
			<div class="toggle-row">
				<button type="button" id="btnHasSpend" class="toggle-btn active">æ”¯å‡ºã‚ã‚Š</button>
				<button type="button" id="btnNoSpend" class="toggle-btn">æ”¯å‡ºãªã—</button>
			</div>
			<div class="ticket-box" id="ticketBox">åˆ©ç”¨ã—ãŸåº—ã®ç·é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
			<div id="spendArea">
				<input type="number" id="ticketInput" class="ticket-input"
					placeholder="ç·é‡‘é¡ (Â¥)" min="0" step="100">
				<div class="input-hint">â€»1000å††ã”ã¨ã«1æ™‚é–“ã€500å††ä»¥ä¸Šã§+30åˆ†ç„¡æ–™</div>
				<div class="action-row">
					<button type="button" class="apply-btn" id="btnApply">é©ç”¨ã™ã‚‹</button>
				</div>
			</div>
			<div id="noSpendHint" class="input-hint" style="display: none;">æ”¯å‡ºãªã—ã®å ´åˆã€ç„¡æ–™æ™‚é–“ã¯
				0åˆ† ã¨ãªã‚Šã¾ã™ã€‚</div>
		</section>

		<!-- Right: ìš”ê¸ˆ ìš”ì•½ -->
		<section class="card right-box">
			<div class="fee-box">
				<div class="row">
					<div class="label">å…¥åº«æ™‚åˆ»ï¼š</div>
					<div class="value" id="entryTime" th:text="${entryTime}">2025-10-29
						13:20</div>
				</div>
				<div class="row">
					<div class="label">åˆ©ç”¨æ™‚é–“ï¼š</div>
					<div class="value">
						<span id="useTime" th:text="${useTime}">2æ™‚é–“30åˆ†</span> <span
							id="useMinutes" th:text="${useMinutes}" style="display: none;">150</span>
					</div>
				</div>

				<div class="fee-grid">
					<div class="fee-item">
						<h4>ç™»éŒ²å‰ã®æ–™é‡‘</h4>
						<div class="amount" id="preAmount">â€•</div>
						<div class="cap-note" id="preCapNote"></div>
					</div>
					<div class="fee-item">
						<h4>ç„¡æ–™é§è»Šæ™‚é–“ï¼ˆç™»éŒ²ï¼‰</h4>
						<div class="amount small" id="freeAmount">0åˆ†</div>
					</div>
					<div class="fee-item" style="grid-column: 1/span 2;">
						<h4>æœ€çµ‚æ–™é‡‘</h4>
						<div class="amount">
							<span class="strike" id="preStrike" style="display: none"></span>
							<span id="finalAmount">â€•</span>
						</div>
						<div class="cap-note" id="finalCapNote"></div>
					</div>
				</div>
			</div>
			<div class="note">â€» æ—¥ãƒ»é€±ãƒ»æœˆã®ä¸Šé™æ–™é‡‘ã‚’è¶…ãˆãªã„ã‚ˆã†è‡ªå‹•ã§èª¿æ•´ã•ã‚Œã¾ã™ã€‚</div>
			<div class="pay-grid" id="payGrid">
				<button class="pay-btn pay-btn--cash" id="btnCash"
					onclick="goPay('cash')">ç¾é‡‘</button>
				<button class="pay-btn pay-btn--card" id="btnCard"
					onclick="goPay('card')">ã‚«ãƒ¼ãƒ‰</button>
			</div>
		</section>
	</main>

	<!-- ë¬´ë£Œ ì§í–‰ í¼ -->
	<form id="autoFreeForm" th:action="@{/kiosk/step5}" method="post"
		style="display: none;">
		<input type="hidden" name="carId" th:value="${carId}"> <input
			type="hidden" name="entryAt" id="entryAtAuto" th:value="${entryTime}">
		<input type="hidden" name="useMinutes" id="useMinutesAuto"
			th:value="${useMinutes}"> <input type="hidden"
			name="freeMinutes" id="freeMinutesAuto"> <input type="hidden"
			name="spendYen" id="spendYenAuto"> <input type="hidden"
			name="rawFeeYen" id="rawFeeAuto"> <input type="hidden"
			name="discountFeeYen" id="discountFeeAuto"> <input
			type="hidden" name="cappedAtYen" id="capAuto"> <input
			type="hidden" name="finalFeeYen" id="finalFeeAuto" value="0">
		<input type="hidden" name="paymentMethod" value="free"> <input
			type="hidden" name="status" value="PAID">
	</form>

	<!-- ìœ ë£Œ ì§„í–‰ í¼ -->
	<form id="toStep4Form" th:action="@{/kiosk/step4}" method="post"
		style="display: none;">
		<input type="hidden" name="carId" th:value="${carId}"> <input
			type="hidden" name="entryAt" id="entryAt" th:value="${entryTime}">
		<input type="hidden" name="useMinutes" id="useMinutesHidden"
			th:value="${useMinutes}"> <input type="hidden"
			name="freeMinutes" id="freeMinutesHidden"> <input
			type="hidden" name="spendYen" id="spendYen"> <input
			type="hidden" name="rawFeeYen" id="rawFeeYen"> <input
			type="hidden" name="discountFeeYen" id="discountFeeYen"> <input
			type="hidden" name="cappedAtYen" id="cappedAtYen"> <input
			type="hidden" name="finalFeeYen" id="finalFeeYen"> <input
			type="hidden" name="amountYen" id="amountYen4"> <input
			type="hidden" name="paymentMethod" id="payMethod"> <input
			type="hidden" name="status" value="PENDING">
	</form>

	<!-- ë¬´ë£Œ ìë™ ì´ë™ ì•ˆë‚´ ì˜¤ë²„ë ˆì´ -->
	<div class="free-overlay" id="freeOverlay" aria-live="assertive"
		role="status">
		<div class="free-panel">
			<div class="spinner"></div>
			<p class="msg" id="freeMsg">ì˜ìˆ˜ì¦ í˜ì´ì§€ë¡œ ì´ë™í•˜ê² ìŠµë‹ˆë‹¤.</p>
			<p class="sub" id="freeSub">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„â€¦</p>
		</div>
	</div>

	<!-- ... ìœ„ìª½ HTML/CSSëŠ” ê·¸ëŒ€ë¡œ ... -->

	<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const btnHasSpend=$('btnHasSpend'), btnNoSpend=$('btnNoSpend'), ticketInput=$('ticketInput');
  const ticketBox=$('ticketBox'), noSpendHint=$('noSpendHint');

  const useMinutesEl=$('useMinutes');
  const preAmount=$('preAmount'), preCapNote=$('preCapNote');
  const freeAmount=$('freeAmount'), preStrike=$('preStrike');
  const finalAmount=$('finalAmount'), finalCapNote=$('finalCapNote');
  const payGrid=$('payGrid'), btnApply=$('btnApply'), btnBack=$('btnBack');

  // hidden
  const useMinHidden=$('useMinutesHidden'), freeMinHidden=$('freeMinutesHidden');
  const spendYenHidden=$('spendYen'), rawFeeYenEl=$('rawFeeYen');
  const discFeeYenEl=$('discountFeeYen'), capYenEl=$('cappedAtYen');
  const finalFeeYenEl=$('finalFeeYen'), amountYen4=$('amountYen4');   // â˜… ìµœì¢…ìš”ê¸ˆ element
  const freeMinAuto=$('freeMinutesAuto'), spendYenAuto=$('spendYenAuto');
  const rawFeeAuto=$('rawFeeAuto'), discFeeAuto=$('discountFeeAuto');
  const capAuto=$('capAuto'), finalFeeAuto=$('finalFeeAuto');
  const autoFreeForm=$('autoFreeForm'), toStep4Form=$('toStep4Form');

  // overlay
  const freeOverlay=$('freeOverlay'), freeMsg=$('freeMsg'), freeSub=$('freeSub');

  const DAY_MIN=1440, WEEK_MIN=10080, MONTH_MIN=43200;
  const CAP_DAY=1500, CAP_WEEK=4500, CAP_MONTH=7500;

  const useMinutes = parseInt((useMinutesEl?.textContent||'0').trim(),10)||0;

  let hasSpend=true, freeMinutes=0, applied=false, submitting=false, redirectTimer=null;

  function rawFee(min){
    if(min<=0) return 0;
    if(min<=30) return 200;
    if(min<=60) return 400;
    return 400 + Math.ceil((min-60)/30)*150;
  }
  function capAmountByUse(u){
    if(u<=DAY_MIN) return CAP_DAY;
    if(u<=WEEK_MIN) return CAP_WEEK;
    return CAP_MONTH;
  }
  function finalAfterFree(useMin, freeMin){
    const remain = Math.max(useMin - freeMin, 0);
    const capped = capAmountByUse(useMin);
    const pre    = Math.min(rawFee(useMin), capped);
    const fin    = Math.min(rawFee(remain), capped);
    return { remain, capped, pre, fin };
  }

  function showFreeOverlayAndSubmit(br){
    if(submitting) return;
    submitting = true;

    // hidden ì±„ìš°ê¸°
    freeMinAuto.value  = freeMinutes;
    spendYenAuto.value = hasSpend ? (parseInt(ticketInput.value||'0',10) || 0) : 0;
    rawFeeAuto.value   = rawFee(useMinutes);
    discFeeAuto.value  = rawFee(Math.min(freeMinutes, useMinutes));
    capAuto.value      = br.capped;
    finalFeeAuto.value = 0;

    freeMsg.textContent = 'ì˜ìˆ˜ì¦ í˜ì´ì§€ë¡œ ì´ë™í•˜ê² ìŠµë‹ˆë‹¤.';
    freeSub.textContent = 'å°‘ã€…ãŠå¾…ã¡ãã ã•ã„â€¦';
    freeOverlay.style.display = 'flex';

    redirectTimer = setTimeout(()=>{ autoFreeForm.submit(); }, 2200);
  }

  function updateFareUI(){
    const br = finalAfterFree(useMinutes, freeMinutes);

    preAmount.textContent  = br.pre.toLocaleString('ja-JP') + 'å††';
    preCapNote.textContent = (rawFee(useMinutes) > br.capped) ? `ä¸Šé™é©ç”¨: ${br.capped.toLocaleString('ja-JP')}å††` : '';

    freeAmount.textContent = `${freeMinutes}åˆ†`;

    if(applied && br.fin < br.pre){
      preStrike.style.display='inline-block';
      preStrike.textContent = br.pre.toLocaleString('ja-JP') + 'å††';
      finalAmount.textContent = br.fin.toLocaleString('ja-JP') + 'å††';
      finalCapNote.textContent= (rawFee(br.remain) > br.capped) ? `ä¸Šé™é©ç”¨: ${br.capped.toLocaleString('ja-JP')}å††` : '';
    }else{
      preStrike.style.display='none';
      preStrike.textContent = '';
      finalAmount.textContent = br.pre.toLocaleString('ja-JP') + 'å††';
      finalCapNote.textContent= preCapNote.textContent;
    }

    // hidden ë™ê¸°í™”
    useMinHidden.value   = useMinutes;
    freeMinHidden.value  = freeMinutes;
    const spendVal = hasSpend ? Math.max(0, parseInt(ticketInput.value||'0',10) || 0) : 0;
    spendYenHidden.value = spendVal;
    rawFeeYenEl.value    = rawFee(useMinutes);
    discFeeYenEl.value   = rawFee(Math.min(freeMinutes, useMinutes));
    capYenEl.value       = br.capped;
    finalFeeYenEl.value  = applied ? br.fin : br.pre;     // â˜… ìµœì¢… ìš”ê¸ˆ
    amountYen4.value     = finalFeeYenEl.value;           // â˜… step4ì— ë„˜ê¸¸ ê¸ˆì•¡

    if(applied){
      if(br.fin <= 0){
        payGrid.style.display = 'none';
        showFreeOverlayAndSubmit(br);
      }else{
        if(redirectTimer){ clearTimeout(redirectTimer); redirectTimer=null; submitting=false; freeOverlay.style.display='none'; }
        payGrid.style.display = 'flex';
      }
    }else{
      payGrid.style.display = 'none';
      if(redirectTimer){ clearTimeout(redirectTimer); redirectTimer=null; submitting=false; freeOverlay.style.display='none'; }
    }
  }

  function reflectToggleUI(){
    btnHasSpend.classList.toggle('active', hasSpend);
    btnNoSpend .classList.toggle('active', !hasSpend);
  }

  function setMode(on){
    hasSpend = !!on;
    applied = false;
    freeMinutes = 0;

    reflectToggleUI();

    ticketInput.disabled = !hasSpend;
    ticketInput.value = '';
    ticketInput.placeholder = hasSpend ? 'ç·é‡‘é¡ (Â¥)' : 'æ”¯å‡ºãªã— ã®ãŸã‚å…¥åŠ›ä¸å¯';
    ticketBox.textContent = hasSpend ? 'åˆ©ç”¨ã—ãŸåº—ã®ç·é‡‘é¡ì„å…¥åŠ›ã—ã¦ãã ã•ã„' : 'æ”¯å‡ºãªã—ï¼ˆç„¡æ–™æ™‚é–“ 0åˆ†ï¼‰';
    noSpendHint.style.display = hasSpend ? 'none' : 'block';

    updateFareUI();

    if(hasSpend){
      setTimeout(()=>ticketInput.focus(),0);
    }else{
      applySpend(true);
    }
  }

  function applySpend(forcedNoSpend=false){
    applied = true;
    let yen = 0;
    if(hasSpend && !forcedNoSpend){
      yen = Math.max(0, parseInt(ticketInput.value||'0',10) || 0);
    }
    const calcFree = (amount)=>{
      const hours = Math.floor(amount/1000)*60;
      const half  = (amount%1000)>=500 ? 30 : 0;
      return hours + half;
    };
    freeMinutes = hasSpend ? calcFree(yen) : 0;

    ticketBox.textContent = hasSpend
      ? `å…¥åŠ›é‡‘é¡ï¼šÂ¥${yen.toLocaleString('ja-JP')} â†’ ç„¡æ–™æ™‚é–“ ${freeMinutes}åˆ†`
      : 'æ”¯å‡ºãªã—ï¼ˆç„¡æ–™æ™‚é–“ 0åˆ†ï¼‰';

    updateFareUI();
  }

  // â˜… ê²°ì œ ë²„íŠ¼: ì„ íƒí•œ ê²°ì œìˆ˜ë‹¨ì„ hiddenì— ì •í™•íˆ ë„£ì–´ì¤€ë‹¤.
  window.goPay = function(method){
    if(submitting) return;
    if(!applied) applySpend();

    const final = parseInt(finalFeeYenEl.value || '0', 10);
    if(final <= 0){ return; }

    submitting = true;
    document.getElementById('payMethod').value = method;  // â˜… 'cash' ë˜ëŠ” 'card'
    toStep4Form.submit();
  };

  // ì´ë²¤íŠ¸
  btnHasSpend.addEventListener('click', ()=> setMode(true));
  btnNoSpend .addEventListener('click',  ()=> setMode(false));
  btnApply   .addEventListener('click',  ()=> applySpend());
  ticketInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); applySpend(); } });

  // â† step2
  btnBack.onclick = ()=>{
    if (document.referrer && /\/kiosk\/step2\b/.test(document.referrer) && history.length > 1) {
      history.back(); return;
    }
    const plate = sessionStorage.getItem('plate');
    if (plate) location.href = '/kiosk/step2?plate=' + encodeURIComponent(plate);
    else location.href = '/kiosk/step2';
  };

  // ì´ˆê¸°
  reflectToggleUI();
  updateFareUI();
})();
</script>
</body>
</html>
