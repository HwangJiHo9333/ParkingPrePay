<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>äº‹å‰ç²¾ç®—ï½œç²¾ç®—æ–¹æ³•é¸æŠ</title>

<style>
:root {
	--bg: #fdf5e6;
	--panel: #fffaf0;
	--text: #444;
	--line: #d8c49b;
	--accent: #d6b85a;
	--hover: #f8efd0;
	--muted: #666;
}

* {
	box-sizing: border-box;
}

html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}

body {
	background: var(--bg);
	color: var(--text);
	font-family: 'Noto Sans JP', 'Malgun Gothic', sans-serif;
	display: flex;
	flex-direction: column;
}

.topbar {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 12px 20px;
	background: var(--panel);
	border-bottom: 2px solid var(--line);
}

.title {
	font-weight: 800;
	text-align: center;
	flex: 1;
}

.actions {
	display: flex;
	gap: 10px;
}

.link-btn {
	border: 2px solid var(--line);
	border-radius: 10px;
	background: var(--bg);
	color: var(--text);
	font-weight: 700;
	cursor: pointer;
	padding: 8px 12px;
	font-size: 13px;
}

.link-btn:hover {
	background: var(--hover);
}

.main-wrap {
	flex: 1;
	display: grid;
	gap: 16px;
	padding: 16px;
	grid-template-columns: 1.1fr 0.9fr;
}

@media ( max-width :980px) {
	.main-wrap {
		grid-template-columns: 1fr;
	}
}

.card {
	background: var(--panel);
	border: 2px solid var(--line);
	border-radius: 12px;
	padding: 20px;
	box-shadow: 0 3px 8px rgba(0, 0, 0, .1);
}

.left-box {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 16px;
}

.toggle-row {
	display: flex;
	gap: 10px;
	justify-content: center;
}

.toggle-btn {
	border: 2px solid var(--line);
	border-radius: 10px;
	background: var(--bg);
	color: var(--text);
	font-weight: 700;
	padding: 10px 16px;
	cursor: pointer;
}

.toggle-btn.active {
	background: var(--accent);
	color: #fff;
}

.ticket-box {
	background: #fff;
	border: 2px dashed var(--line);
	border-radius: 12px;
	width: 80%;
	min-height: 120px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 18px;
	color: var(--muted);
	text-align: center;
	padding: 12px;
}

#spendArea {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	width: 100%;
	gap: 10px;
}

.ticket-input {
	font-size: 20px;
	padding: 10px;
	width: 80%;
	border: 2px solid var(--line);
	border-radius: 8px;
	text-align: right;
}

.ticket-input:disabled {
	background: #f2f2f2;
	color: #999;
	cursor: not-allowed;
}

.input-hint {
	font-size: 13px;
	color: var(--muted);
}

.fee-box {
	font-size: 18px;
	line-height: 1.8;
	border: 2px solid var(--line);
	border-radius: 12px;
	background: #fff;
	padding: 16px;
}

.fee-box .row {
	display: flex;
	justify-content: space-between;
}

.fee-box .label {
	color: var(--muted);
}

.fee-box .value {
	font-weight: 700;
}

.pay-grid {
	display: flex;
	gap: 16px;
	justify-content: center;
	margin-top: 20px;
}

.pay-btn {
	width: 160px;
	padding: 18px 0;
	font-size: 20px;
	font-weight: 700;
	border-radius: 12px;
	border: 2px solid var(--line);
	cursor: pointer;
}

.pay-btn--cash {
	background: #ffe4b5;
}

.pay-btn--card {
	background: #e6d690;
}

.hidden {
	display: none;
}
</style>
</head>

<body>
	<div class="topbar">
		<div class="actions">
			<a href="/kiosk/step1" class="link-btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
		</div>
		<div class="title">ã”åˆ©ç”¨æ–™é‡‘ã®ç²¾ç®—</div>
		<div class="actions">
			<button class="link-btn">English</button>
		</div>
	</div>

	<main class="main-wrap">
		<section class="card left-box">
			<h2>ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã‚’ã”ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h2>

			<div class="toggle-row">
				<button type="button" id="btnHasSpend" class="toggle-btn active">æ”¯å‡ºã‚ã‚Š</button>
				<button type="button" id="btnNoSpend" class="toggle-btn">æ”¯å‡ºãªã—</button>
			</div>

			<div class="ticket-box" id="ticketBox">åˆ©ç”¨ã—ãŸåº—ã®ç·é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

			<!-- spendAreaëŠ” í•­ìƒ ë³´ì´ê³ , 'æ”¯å‡ºãªã—'ì¼ ë•Œ ì…ë ¥ë§Œ ë¹„í™œì„±í™” -->
			<div id="spendArea">
				<input type="number" id="ticketInput" class="ticket-input"
					placeholder="ç·é‡‘é¡ (Â¥)" min="0" step="100">
				<div class="input-hint">â€»1000å††ã”ã¨ã«1æ™‚é–“ã€500å††ä»¥ä¸Šã§+30åˆ†ç„¡æ–™</div>
				<button type="button" class="toggle-btn active" id="btnApply">é©ç”¨ã™ã‚‹</button>
			</div>

			<div id="noSpendHint" class="note hidden">æ”¯å‡ºãªã—ã®å ´åˆã€ç„¡æ–™æ™‚é–“ã¯ 0åˆ†
				ã¨ãªã‚Šã¾ã™ã€‚</div>
		</section>

		<section class="card right-box">
			<div class="fee-box">
				<div class="row">
					<div class="label">å…¥åº«æ™‚åˆ»ï¼š</div>
					<div class="value" id="entryTime" th:text="${entryTime}">2025-10-29
						13:20</div>
				</div>
				<div class="row">
					<div class="label">åˆ©ç”¨æ™‚é–“ï¼š</div>
					<div class="value">
						<span id="useTime" th:text="${useTime}">2æ™‚é–“30åˆ†</span> <span
							id="useMinutes" th:text="${useMinutes}" style="display: none;">150</span>
					</div>
				</div>
				<div class="row">
					<div class="label">ç„¡æ–™é§è»Šæ™‚é–“ï¼š</div>
					<div class="value" id="freeTime">â€•</div>
				</div>
				<div class="row">
					<div class="label">åˆ©ç”¨æ–™é‡‘ï¼š</div>
					<div class="value" id="totalFee">â€•</div>
				</div>
			</div>

			<div class="pay-grid" id="payGrid" style="display: none;">
				<button class="pay-btn pay-btn--cash" onclick="goPay('cash')">ç¾é‡‘</button>
				<button class="pay-btn pay-btn--card" onclick="goPay('card')">ã‚«ãƒ¼ãƒ‰</button>
			</div>
		</section>
	</main>

	<!-- 0ì›(ë¬´ë£Œ) ì¦‰ì‹œ ì™„ë£Œìš©: step5ë¡œ ì§í–‰, DBì—” PAID/freeë¡œ ì €ì¥ -->
	<form id="autoFreeForm" th:action="@{/kiosk/step5}" method="post"
		style="display: none;">
		<input type="hidden" name="carId" th:value="${carId}"> <input
			type="hidden" name="entryAt" id="entryAtAuto" th:value="${entryTime}">
		<input type="hidden" name="useMinutes" id="useMinutesAuto"
			th:value="${useMinutes}"> <input type="hidden"
			name="freeMinutes" id="freeMinutesAuto"> <input type="hidden"
			name="spendYen" id="spendYenAuto"> <input type="hidden"
			name="rawFeeYen" id="rawFeeAuto"> <input type="hidden"
			name="discountFeeYen" id="discountFeeAuto"> <input
			type="hidden" name="cappedAtYen" id="capAuto"> <input
			type="hidden" name="finalFeeYen" id="finalFeeAuto" value="0">
		<input type="hidden" name="paymentMethod" value="free"> <input
			type="hidden" name="status" value="PAID">
	</form>

	<!-- ìœ ë£Œ ê²°ì œ ì§„í–‰ìš©: step4ë¡œ ì´ë™, DBì—” PENDING ì €ì¥ -->
	<form id="toStep4Form" th:action="@{/kiosk/step4}" method="post"
		style="display: none;">
		<input type="hidden" name="carId" th:value="${carId}"> <input
			type="hidden" name="entryAt" id="entryAt" th:value="${entryTime}">
		<input type="hidden" name="useMinutes" id="useMinutesHidden"
			th:value="${useMinutes}"> <input type="hidden"
			name="freeMinutes" id="freeMinutesHidden"> <input
			type="hidden" name="spendYen" id="spendYen"> <input
			type="hidden" name="rawFeeYen" id="rawFeeYen"> <input
			type="hidden" name="discountFeeYen" id="discountFeeYen"> <input
			type="hidden" name="cappedAtYen" id="cappedAtYen"> <input
			type="hidden" name="finalFeeYen" id="finalFeeYen">

		<!-- step4ì—ì„œ ì´ì•¡ë§Œ ë³„ë„ë¡œ ì“°ê³  ìˆìœ¼ë©´ ìœ ì§€ -->
		<input type="hidden" name="amountYen" id="amountYen4"> <input
			type="hidden" name="paymentMethod" id="payMethod"> <input
			type="hidden" name="status" value="PENDING">
	</form>

	<script>
  (function(){
    const btnHasSpend = document.getElementById('btnHasSpend');
    const btnNoSpend  = document.getElementById('btnNoSpend');
    const ticketInput = document.getElementById('ticketInput');
    const ticketBox   = document.getElementById('ticketBox');
    const noSpendHint = document.getElementById('noSpendHint');
    const freeTimeEl  = document.getElementById('freeTime');
    const totalFeeEl  = document.getElementById('totalFee');
    const useMinutesEl= document.getElementById('useMinutes');
    const payGrid     = document.getElementById('payGrid');
    const btnApply    = document.getElementById('btnApply');

    // step4 ì „ì†¡ìš© hidden
    const useMinHidden   = document.getElementById('useMinutesHidden');
    const freeMinHidden  = document.getElementById('freeMinutesHidden');
    const spendYenHidden = document.getElementById('spendYen');
    const rawFeeYenEl    = document.getElementById('rawFeeYen');
    const discFeeYenEl   = document.getElementById('discountFeeYen');
    const capYenEl       = document.getElementById('cappedAtYen');
    const finalFeeYenEl  = document.getElementById('finalFeeYen');
    const amountYen4     = document.getElementById('amountYen4');
    const payMethod      = document.getElementById('payMethod');

    // step5(ë¬´ë£Œ ì§í–‰) ì „ì†¡ìš© hidden
    const useMinAuto     = document.getElementById('useMinutesAuto');
    const freeMinAuto    = document.getElementById('freeMinutesAuto');
    const spendYenAuto   = document.getElementById('spendYenAuto');
    const rawFeeAuto     = document.getElementById('rawFeeAuto');
    const discFeeAuto    = document.getElementById('discountFeeAuto');
    const capAuto        = document.getElementById('capAuto');
    const finalFeeAuto   = document.getElementById('finalFeeAuto');

    const autoFreeForm   = document.getElementById('autoFreeForm');
    const toStep4Form    = document.getElementById('toStep4Form');

    const DAY_MIN=1440, WEEK_MIN=10080, MONTH_MIN=43200;
    const CAP_DAY=1500, CAP_WEEK=4500, CAP_MONTH=7500;

    const useMinutes = parseInt((useMinutesEl.textContent||'0').trim(),10)||0;

    let hasSpend = true, freeMinutes = 0, applied = false, payAmount = 0;

    function rawFee(min){
      if(min<=0) return 0;
      if(min<=30) return 200;
      if(min<=60) return 400;
      return 400 + Math.ceil((min-60)/30)*150;
    }
    function capAmountByUse(u){
      if(u<=DAY_MIN) return CAP_DAY;
      if(u<=WEEK_MIN) return CAP_WEEK;
      return CAP_MONTH;
    }
    function feeBreakdown(useMin, freeMin){
      const full   = rawFee(useMin);
      const free   = rawFee(freeMin);
      const capped = capAmountByUse(useMin);
      const final  = Math.min(Math.max(full - free, 0), capped);
      return { full, free, capped, final };
    }
    function updateDisplay(){
      if(!applied){
        freeTimeEl.textContent='â€•';
        totalFeeEl.textContent='â€•';
        payGrid.style.display='none';
        return;
      }
      const br = feeBreakdown(useMinutes, freeMinutes);
      freeTimeEl.textContent = `${freeMinutes}åˆ†`;
      totalFeeEl.textContent = br.final.toLocaleString('ja-JP')+'å††';
      payGrid.style.display   = 'flex';
      payAmount = br.final;
    }

    // ì§€ì¶œ ì—¬ë¶€ ëª¨ë“œ ì „í™˜
    function setMode(on){
      hasSpend = !!on;
      applied = false;
      freeMinutes = 0;
      payAmount = 0;

      // ë²„íŠ¼ active í† ê¸€
      btnHasSpend.classList.toggle('active', hasSpend);
      btnNoSpend.classList.toggle('active', !hasSpend);

      // ì…ë ¥ì°½ í™œì„±/ë¹„í™œì„± ë° placeholder
      ticketInput.disabled = !hasSpend;
      ticketInput.value = '';
      ticketInput.placeholder = hasSpend ? 'ç·é‡‘é¡ (Â¥)' : 'æ”¯å‡ºãªã— ã®ãŸã‚å…¥åŠ›ä¸å¯';
      ticketBox.textContent = hasSpend
        ? 'åˆ©ç”¨ã—ãŸåº—ã®ç·é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
        : 'æ”¯å‡ºãªã—ï¼ˆç„¡æ–™æ™‚é–“ 0åˆ†ï¼‰';

      // ì•ˆë‚´ë¬¸ í† ê¸€
      noSpendHint.classList.toggle('hidden', hasSpend);

      // ì§€ì¶œ ìˆìŒì´ë©´ ìë™ í¬ì»¤ìŠ¤
      if(hasSpend){
        setTimeout(()=>ticketInput.focus(), 0);
      }

      updateDisplay();
    }

    // ë¬´ë£Œì‹œê°„ ê³„ì‚° í›„ í‘œì‹œ
    function applySpend(){
      applied = true;
      let yen = 0;
      if(hasSpend){
        yen = Math.max(0, parseInt(ticketInput.value||'0',10) || 0);
      }
      const calcFree = (amount)=>{
        const hours = Math.floor(amount/1000)*60;
        const half  = (amount%1000)>=500 ? 30 : 0;
        return hours + half;
      };
      freeMinutes = hasSpend ? calcFree(yen) : 0;

      ticketBox.textContent = hasSpend
        ? `å…¥åŠ›é‡‘é¡ï¼šÂ¥${yen.toLocaleString('ja-JP')} â†’ ç„¡æ–™æ™‚é–“ ${freeMinutes}åˆ†`
        : 'æ”¯å‡ºãªã—ï¼ˆç„¡æ–™æ™‚é–“ 0åˆ†ï¼‰';

      updateDisplay();
    }

    // ê²°ì œ ì§„í–‰
    window.goPay = function(method){
      if(!applied) return;

      const spend = hasSpend ? (parseInt(ticketInput.value||'0',10)||0) : 0;
      const br    = feeBreakdown(useMinutes, freeMinutes);

      // 0ì›(ë¬´ë£Œ)ì¸ ê²½ìš°: step5ë¡œ ì§í–‰ â†’ DBì— PAID/freeë¡œ ì €ì¥
      if(br.final <= 0){
        // ìë™ í¼ ê°’ ì±„ì›€
        freeMinAuto.value  = freeMinutes;
        spendYenAuto.value = spend;
        rawFeeAuto.value   = br.full;
        discFeeAuto.value  = br.free;
        capAuto.value      = br.capped;
        finalFeeAuto.value = 0; // ëª…ì‹œ
        autoFreeForm.submit();
        return;
      }

      // ìœ ë£Œ ê²°ì œ: step4ë¡œ ì´ë™ â†’ DBì— PENDING ì €ì¥
      // ìƒì„¸ê°’ ì±„ì›Œ ë„£ê¸°
      useMinHidden.value   = useMinutes;
      freeMinHidden.value  = freeMinutes;
      spendYenHidden.value = spend;
      rawFeeYenEl.value    = br.full;
      discFeeYenEl.value   = br.free;
      capYenEl.value       = br.capped;
      finalFeeYenEl.value  = br.final;

      amountYen4.value     = br.final; // í˜¸í™˜ ìœ„í•´ ìœ ì§€
      payMethod.value      = method;

      toStep4Form.submit();
    };

    // ì´ë²¤íŠ¸
    btnHasSpend.addEventListener('click', ()=> setMode(true));
    btnNoSpend .addEventListener('click', ()=> setMode(false));
    btnApply   .addEventListener('click', applySpend);

    // ì…ë ¥ì°½ì—ì„œ Enterë¡œë„ ì ìš©
    ticketInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        applySpend();
      }
    });

    // ì´ˆê¸° ìƒíƒœ: ì§€ì¶œ ìˆìŒ
    setMode(true);
  })();
  </script>
</body>
</html>
