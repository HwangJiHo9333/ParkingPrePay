<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>äº‹å‰ç²¾ç®—ï½œç²¾ç®—æ–¹æ³•é¸æŠ</title>

<style>
:root {
	--bg: #fdf5e6;
	--panel: #fffaf0;
	--text: #444;
	--line: #d8c49b;
	--accent: #d6b85a;
	--hover: #f8efd0;
	--muted: #666;
}
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; padding: 0; }
body {
	background: var(--bg);
	color: var(--text);
	font-family: 'Noto Sans JP', 'Malgun Gothic', sans-serif;
	display: flex; flex-direction: column;
}
/* ìƒë‹¨ë°” */
.topbar {
	display: flex; justify-content: space-between; align-items: center;
	padding: 12px 20px; background: var(--panel);
	border-bottom: 2px solid var(--line);
}
.title { font-weight: 800; text-align: center; flex: 1; }
.actions { display: flex; gap: 10px; }
.link-btn {
	border: 2px solid var(--line); border-radius: 10px;
	background: var(--bg); color: var(--text);
	font-weight: 700; cursor: pointer; padding: 8px 12px; font-size: 13px;
}
.link-btn:hover { background: var(--hover); }

/* ë ˆì´ì•„ì›ƒ */
.main-wrap {
	flex: 1; display: grid; gap: 16px; padding: 16px;
	grid-template-columns: 1.1fr 0.9fr;
}
@media (max-width: 980px) { .main-wrap { grid-template-columns: 1fr; } }

/* ì¹´ë“œ */
.card {
	background: var(--panel); border: 2px solid var(--line);
	border-radius: 12px; padding: 20px;
	box-shadow: 0 3px 8px rgba(0,0,0,.1);
}

/* ===== ì™¼ìª½: ì„œë¹„ìŠ¤ ì‹œê°„ ë“±ë¡ ===== */
.left-box { display: flex; flex-direction: column; align-items: center; gap: 16px; }
.left-box h2 { margin: 0; text-align: center; }
.ticket-box {
	background: #fff; border: 2px dashed var(--line); border-radius: 12px;
	width: 80%; min-height: 120px;
	display: flex; align-items: center; justify-content: center;
	font-size: 18px; color: var(--muted); text-align: center; padding: 12px;
}
.ticket-input {
	font-size: 20px; padding: 10px; width: 80%;
	border: 2px solid var(--line); border-radius: 8px; text-align: right;
}
.input-hint { font-size: 13px; color: var(--muted); }

.k-btn {
	border: 2px solid var(--line); border-radius: 10px;
	background: var(--bg); color: var(--text); font-weight: 700;
	padding: 12px 28px; font-size: 18px; cursor: pointer;
	transition: background .2s ease, transform .05s ease;
}
.k-btn:hover { background: var(--hover); }
.k-btn:active { transform: translateY(1px); }
.k-btn--accent { background: var(--accent); color: #fff; }
.k-btn--accent:hover { background: #caaa45; }

/* ===== ì˜¤ë¥¸ìª½: ìš”ê¸ˆ ë° ê²°ì œìˆ˜ë‹¨ ===== */
.right-box h2 { text-align: center; margin-top: 0; }
.fee-box {
	font-size: 18px; line-height: 1.8;
	border: 2px solid var(--line); border-radius: 12px;
	background: #fff; padding: 16px;
}
.fee-box .row { display: flex; justify-content: space-between; gap: 12px; }
.fee-box .label { color: var(--muted); }
.fee-box .value { font-weight: 700; }

.pay-grid {
	display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin-top: 20px;
}
.pay-btn {
	width: 160px; padding: 18px 0; font-size: 20px; font-weight: 700;
	border: 2px solid var(--line); border-radius: 12px; background: var(--bg);
	cursor: pointer; transition: background .2s;
}
.pay-btn:hover { background: var(--hover); }
.pay-btn--cash { background: #ffe4b5; }
.pay-btn--card { background: #e6d690; }
.pay-btn--receipt { background: #f1deb5; }
</style>
</head>

<body>
	<!-- ìƒë‹¨ë°” -->
	<div class="topbar">
		<div class="actions">
			<a href="/kiosk/step1" class="link-btn" id="btnHome">ğŸ  ãƒ›ãƒ¼ãƒ </a>
		</div>
		<div class="title" id="titleText">ã”åˆ©ç”¨æ–™é‡‘ã®ç²¾ç®—</div>
		<div class="actions">
			<button type="button" class="link-btn" id="btnLang">English</button>
		</div>
	</div>

	<!-- ë©”ì¸ -->
	<main class="main-wrap">
		<!-- ì™¼ìª½: ì„œë¹„ìŠ¤ ì‹œê°„ ë“±ë¡ -->
		<section class="card left-box">
			<h2 id="guideText">ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã‚’ã”ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h2>

			<div class="ticket-box" id="ticketBox">
				åˆ©ç”¨ã—ãŸåº—ã®ç·é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
			</div>

			<input type="number" inputmode="numeric" class="ticket-input" id="ticketInput"
				   placeholder="ç·é‡‘é¡ (Â¥)" min="0" step="100">

			<div class="input-hint">â€»1000å††ã”ã¨ã« 1æ™‚é–“ã€æ®‹ã‚Š500å††ã”ã¨ã« 30åˆ†ã®ç„¡æ–™æ™‚é–“ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚</div>

			<button class="k-btn k-btn--accent" id="btnApply">é©ç”¨ã™ã‚‹</button>
		</section>

		<!-- ì˜¤ë¥¸ìª½: ì´ìš©ìš”ê¸ˆ -->
		<section class="card right-box">
			<h2 id="feeTitle">ã”åˆ©ç”¨æ–™é‡‘</h2>
			<div class="fee-box" id="feeBox">
				<div class="row">
					<div class="label">å…¥åº«æ™‚åˆ»ï¼š</div>
					<div class="value" id="entryTime" th:text="${entryTime}">2025-10-29 13:20</div>
				</div>
				<div class="row">
					<div class="label">åˆ©ç”¨æ™‚é–“ï¼š</div>
					<div class="value">
						<span id="useTime" th:text="${useTime}">2æ™‚é–“30åˆ†</span>
						<span id="useMinutes" th:text="${useMinutes}" style="display:none;">150</span>
					</div>
				</div>
				<div class="row">
					<div class="label">ç„¡æ–™é§è»Šæ™‚é–“ï¼š</div>
					<div class="value" id="freeTime">0åˆ†</div>
				</div>
				<div class="row">
					<div class="label">åˆ©ç”¨æ–™é‡‘ï¼š</div>
					<div class="value" id="totalFee" th:text="${fee}">Â¥2,000</div>
				</div>
			</div>

			<div class="pay-grid">
				<button class="pay-btn pay-btn--cash" onclick="selectPay('cash')">ç¾é‡‘</button>
				<button class="pay-btn pay-btn--card" onclick="selectPay('card')">ã‚«ãƒ¼ãƒ‰</button>
				<button class="pay-btn pay-btn--receipt" onclick="selectPay('receipt')">é ˜åæ›¸ç™ºè¡Œ</button>
			</div>
		</section>
	</main>

<script>
(function(){
  let lang = localStorage.getItem('kiosk_lang') || 'ja';
  const bLang   = document.getElementById('btnLang');
  const bHome   = document.getElementById('btnHome');
  const tText   = document.getElementById('titleText');
  const gText   = document.getElementById('guideText');
  const fTitle  = document.getElementById('feeTitle');
  const btnApply= document.getElementById('btnApply');
  const ticketBox  = document.getElementById('ticketBox');
  const ticketInput= document.getElementById('ticketInput');
  const totalFeeEl = document.getElementById('totalFee');

  // ì´ˆê¸° ìš”ê¸ˆ(ë¬¸ì â†’ ìˆ«ì) ë³´ì¡´
  const initialFee = (totalFeeEl.textContent || '')
                      .replace(/[^\d]/g,'')
                      .trim();
  const baseFee = initialFee ? parseInt(initialFee) : null;

  const i18n = {
    ja: {
      title:"ã”åˆ©ç”¨æ–™é‡‘ã®ç²¾ç®—",
      guide:"ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã‚’ã”ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ",
      scan:"åˆ©ç”¨ã—ãŸåº—ã®ç·é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      apply:"é©ç”¨ã™ã‚‹",
      fee:"ã”åˆ©ç”¨æ–™é‡‘",
      home:"ãƒ›ãƒ¼ãƒ ",
      langToggle:"English",
      appliedPrefix:"ç„¡æ–™ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ï¼š",
      covered:"ç„¡æ–™æ™‚é–“ãŒåˆ©ç”¨æ™‚é–“ã‚’è¶…ãˆã¾ã—ãŸã€‚å®Œäº†ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚"
    },
    en: {
      title:"Payment Details",
      guide:"Would you like to register service time?",
      scan:"Enter the total amount spent at the shop",
      apply:"Apply",
      fee:"Parking Fee",
      home:"Home",
      langToggle:"æ—¥æœ¬èª",
      appliedPrefix:"Free service time: ",
      covered:"Free time exceeds your stay. Redirecting to finish screen."
    }
  };

  function setLang(){
    const t = i18n[lang];
    tText.textContent  = t.title;
    gText.textContent  = t.guide;
    ticketBox.textContent = t.scan;
    btnApply.textContent  = t.apply;
    fTitle.textContent    = t.fee;
    bHome.textContent     = t.home;
    bLang.textContent     = t.langToggle;
  }
  bLang.onclick = () => { lang = (lang==='ja' ? 'en' : 'ja'); localStorage.setItem('kiosk_lang', lang); setLang(); };
  setLang();

  // ---- "2æ™‚é–“30åˆ†" â†’ ë¶„ ë‹¨ìœ„ íŒŒì‹± (ì„œë²„ì—ì„œ useMinutes ë‚´ë ¤ì£¼ë©´ ê·¸ ê°’ì„ ìš°ì„  ì‚¬ìš©)
  function parseUseMinutes() {
    const server = document.getElementById('useMinutes');
    if (server && server.textContent && !isNaN(parseInt(server.textContent))) {
      return parseInt(server.textContent);
    }
    const txt = document.getElementById('useTime').textContent.trim();
    let h = 0, m = 0;
    const hMatch = txt.match(/(\d+)\s*æ™‚é–“/);
    const mMatch = txt.match(/(\d+)\s*åˆ†/);
    if (hMatch) h = parseInt(hMatch[1]);
    if (mMatch) m = parseInt(mMatch[1]);
    if (!hMatch && !mMatch) { // ì˜ë¬¸ ì¼€ì´ìŠ¤ ëŒ€ë¹„
      const h2 = txt.match(/(\d+)\s*h/);
      const m2 = txt.match(/(\d+)\s*m/);
      if (h2) h = parseInt(h2[1]);
      if (m2) m = parseInt(m2[1]);
    }
    return h*60 + m;
  }

  // ë¶„ â†’ "Xæ™‚é–“Yåˆ†" ë¬¸ìì—´
  function fmtMinutes(min) {
    if (min <= 0) return (lang==='ja' ? '0åˆ†' : '0m');
    const h = Math.floor(min / 60);
    const m = min % 60;
    if (lang==='ja') {
      if (h>0 && m>0) return `${h}æ™‚é–“${m}åˆ†`;
      if (h>0) return `${h}æ™‚é–“`;
      return `${m}åˆ†`;
    } else {
      if (h>0 && m>0) return `${h}h ${m}m`;
      if (h>0) return `${h}h`;
      return `${m}m`;
    }
  }

  // ---- ì„œë¹„ìŠ¤ ì‹œê°„ ê³„ì‚°: 1000å††ë‹¹ 60ë¶„ + æ®‹ã‚Š500å††ë‹¹ 30åˆ†
  function calcFreeMinutes(amountYen) {
    const thousands = Math.floor(amountYen / 1000);
    const remainder = amountYen % 1000;
    const extra30   = Math.floor(remainder / 500);
    return thousands * 60 + extra30 * 30;
  }

  document.getElementById('btnApply').addEventListener('click', () => {
    // ê¸ˆì•¡ íŒŒì‹±
    const raw = (ticketInput.value || '').toString().replace(/[^\d]/g, '');
    const amount = parseInt(raw || '0');
    if (isNaN(amount) || amount <= 0) {
      alert(lang==='ja' ? 'ç·é‡‘é¡(Â¥)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' : 'Please enter total amount (Â¥).');
      ticketInput.focus();
      return;
    }

    const freeMin = calcFreeMinutes(amount);
    const useMin  = parseUseMinutes();
    const billMin = Math.max(0, useMin - freeMin);

    // ì¢Œì¸¡ ì•ˆë‚´ ë©”ì‹œì§€ ê°±ì‹ 
    ticketBox.style.color = "#2e7d32";
    ticketBox.textContent = `${i18n[lang].appliedPrefix}${fmtMinutes(freeMin)}`;

    // ì˜¤ë¥¸ìª½ í‘œì‹œ ê°±ì‹ : ë¬´ë£Œ ì£¼ì°¨ì‹œê°„
    document.getElementById('freeTime').textContent = fmtMinutes(freeMin);

    // ìš”ê¸ˆ(í‘œì‹œë§Œ): ì „ì•¡ ë¬´ë£Œì¼ ë•Œë§Œ 0ìœ¼ë¡œ
    if (billMin === 0) {
      if (baseFee !== null) totalFeeEl.textContent = 'Â¥0';
      setTimeout(() => {
        alert(i18n[lang].covered);
        window.location.href = "/kiosk/step5";
      }, 1200);
    } else {
      // ë¶€ë¶„ í• ì¸ì¸ ê²½ìš°, ì‹¤ì œ ìš”ê¸ˆ ë¡œì§ì€ ì„œë²„ ìš”ìœ¨ í‘œê°€ í•„ìš”í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ í‘œì‹œ ìœ ì§€
      if (baseFee !== null) {
        totalFeeEl.textContent = `Â¥${Number(baseFee).toLocaleString()}`;
      }
    }
  });
})();

function selectPay(method){
  let msg = "";
  switch(method){
    case 'cash': msg="ç¾é‡‘ã‚’æŠ•å…¥ã—ã¦ãã ã•ã„ã€‚"; break;
    case 'card': msg="ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚"; break;
    case 'receipt': msg="é ˜åæ›¸ã‚’å°åˆ·ã—ã¦ã„ã¾ã™..."; break;
  }
  alert(msg);
  if(method!=='receipt'){
    setTimeout(()=>window.location.href="/kiosk/step5",1200);
  }
}
</script>
</body>
</html>
