<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>äº‹å‰ç²¾ç®—ï½œãŠæ”¯æ‰•ã„</title>

<style>
:root {
	--bg: #fdf5e6;
	--panel: #fffaf0;
	--text: #444;
	--line: #d8c49b;
	--accent: #d6b85a;
	--hover: #f8efd0;
	--muted: #666;
	--bad: #d9534f;
}

* {
	box-sizing: border-box;
}

html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}

body {
	background: var(--bg);
	color: var(--text);
	font-family: 'Noto Sans JP', 'Malgun Gothic', sans-serif;
	display: flex;
	flex-direction: column;
}

/* Topbar */
.topbar {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 12px 20px;
	background: var(--panel);
	border-bottom: 2px solid var(--line);
}

.actions-left, .actions-right {
	display: flex;
	gap: 10px;
	align-items: center;
}

.link-btn {
	border: 2px solid var(--line);
	border-radius: 12px;
	background: var(--bg);
	padding: 10px 16px;
	font-weight: 800;
	cursor: pointer;
	text-decoration: none;
	color: inherit;
	font-size: 16px;
}

.link-btn:hover {
	background: var(--hover);
}

.title {
	font-weight: 900;
	font-size: clamp(18px, 2.2vw, 22px);
	text-align: center;
}

/* Layout: ì¢Œìš° ê· ë“± */
.main-wrap {
	flex: 1;
	display: grid;
	gap: 18px;
	padding: 18px;
	grid-template-columns: 1fr 1fr;
	align-items: stretch;
	min-height: 0;
}

@media ( max-width : 980px) {
	.main-wrap {
		grid-template-columns: 1fr;
	}
}

/* ì¹´ë“œ ê³µí†µ */
.card {
	background: var(--panel);
	border: 2px solid var(--line);
	border-radius: 16px;
	padding: 20px;
	box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
	display: flex;
	flex-direction: column;
	min-height: 0;
}

/* ì¢Œì¸¡ ìš”ì•½ */
.summary h2 {
	margin: 0 0 12px;
	text-align: center;
	font-size: clamp(20px, 2.4vw, 26px);
	font-weight: 900;
}

.fee-box {
	font-size: 18px;
	line-height: 1.8;
	border: 2px solid var(--line);
	border-radius: 14px;
	background: #fff;
	padding: 16px;
	flex: 1;
	display: flex;
	flex-direction: column;
	gap: 8px;
	overflow: auto;
}

.fee-box .row {
	display: flex;
	justify-content: space-between;
	align-items: center;
	gap: 12px;
}

.fee-box .label {
	color: var(--muted);
	font-weight: 700;
}

.fee-box .value {
	font-weight: 900;
}

.card-ment {
	font-size: 15px;
	text-align: center;
	color: var(--muted);
	margin-top: 10px;
}

/* ìš°ì¸¡ ê²°ì œ */
.pay h2 {
	margin: 0 0 12px;
	text-align: center;
	font-size: clamp(20px, 2.4vw, 26px);
	font-weight: 900;
}

.amount {
	font-size: clamp(22px, 2.6vw, 28px);
	font-weight: 900;
	text-align: center;
	margin: 0 0 14px;
}

.bad-text {
	color: var(--bad);
	font-size: clamp(14px, 1.8vw, 16px);
	margin: 0 0 8px;
	font-weight: 900;
	text-align: center;
	display: none;
}

.input-cash {
	font-size: clamp(18px, 2.2vw, 22px);
	text-align: right;
	padding: 12px;
	width: 100%;
	border: 2px solid var(--line);
	border-radius: 12px;
	background: #fff;
}

.k-btn {
	border: 2px solid var(--line);
	border-radius: 12px;
	background: var(--accent);
	color: #fff;
	font-weight: 900;
	padding: 14px 18px;
	font-size: clamp(18px, 2.2vw, 22px);
	cursor: pointer;
	width: 100%;
	margin-top: 16px;
}

.k-btn[disabled] {
	opacity: .5;
	cursor: not-allowed;
}

.k-btn:hover:not([disabled]) {
	background: #caaa45;
}

/* ì¹´ë“œ ì²˜ë¦¬ ì• ë‹ˆë©”ì´ì…˜ */
.process-box {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 12px;
	margin-top: 8px;
}

.spinner {
	width: 44px;
	height: 44px;
	border-radius: 50%;
	border: 4px solid #ddd;
	border-top-color: var(--accent);
	animation: spin 1s linear infinite;
}

/* keyframes */
@keyframes spin {to { transform:rotate(360deg);
	
}

}
.proc-text {
	color: var(--muted);
	font-weight: 700;
}
</style>
</head>

<body>
	<!-- ìƒë‹¨ë°” -->
	<div class="topbar">
		<div class="actions-left">
			<a class="link-btn" href="/kiosk/step1" id="btnHome">ğŸ  ãƒ›ãƒ¼ãƒ </a> <a
				class="link-btn" th:href="@{/kiosk/step3(carId=${carId})}"
				id="btnBack">â† æˆ»ã‚‹</a>
		</div>
		<div class="title" id="titleText">ãŠæ”¯æ‰•ã„</div>
		<div class="actions-right">
			<button class="link-btn" id="btnLang">English</button>
		</div>
	</div>

	<!-- ë©”ì¸ -->
	<main class="main-wrap">
		<!-- ì™¼ìª½: ìš”ì•½ -->
		<section class="card summary">
			<h2 id="hSummary">ã”åˆ©ç”¨å†…å®¹</h2>
			<div class="fee-box">
				<div class="row">
					<div class="label" id="lblEntry">å…¥åº«æ™‚åˆ»ï¼š</div>
					<div class="value" id="valEntry" th:text="${entryTime}">2025-10-29
						13:20</div>
				</div>
				<div class="row">
					<div class="label" id="lblExit">å‡ºåº«æ™‚åˆ»ï¼š</div>
					<div class="value" id="valExit" th:text="${exitTime}">2025-10-29
						14:50</div>
				</div>
				<div class="row">
					<div class="label" id="lblUse">åˆ©ç”¨æ™‚é–“ï¼š</div>
					<div class="value">
						<span id="valUseText" th:text="${useTime}">2æ™‚é–“30åˆ†</span> <span
							id="useMinutes" th:text="${useMinutes}" style="display: none;">150</span>
					</div>
				</div>
				<div class="row">
					<div class="label" id="lblFree">ç„¡æ–™é§è»Šæ™‚é–“ï¼š</div>
					<div class="value" id="valFree"
						th:text="${freeTime != null} ? ${freeTime} : ${freeMinutes} + 'åˆ†'">60åˆ†</div>
				</div>
				<div class="row">
					<div class="label" id="lblTotal">åˆ©ç”¨æ–™é‡‘ï¼š</div>
					<div class="value">
						<span id="needAmount" th:text="${totalFee}">0</span>å††
					</div>
				</div>
				<div class="row">
					<div class="label" id="lblMethod">æ”¯æ‰•æ–¹æ³•ï¼š</div>
					<div class="value" id="valMethod"
						th:text="${paymentMethod == 'cash' ? 'ç¾é‡‘' : 'ã‚«ãƒ¼ãƒ‰'}">ç¾é‡‘</div>
				</div>
			</div>
			<div th:if="${paymentMethod == 'card'}" class="card-ment"
				id="cardMent">ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã€æ¡ˆå†…ã«å¾“ã£ã¦ãã ã•ã„ã€‚</div>
		</section>

		<!-- ì˜¤ë¥¸ìª½: ê²°ì œ -->
		<section class="card pay">
			<h2 id="hPay"
				th:text="${paymentMethod == 'card' ? 'ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ' : 'ç¾é‡‘æ”¯æ‰•ã„'}">ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ</h2>
			<div class="amount" id="amtText">
				ãŠæ”¯æ‰•ã„é‡‘é¡ï¼š<span th:text="${totalFee}">0</span>å††
			</div>

			<!-- í˜„ê¸ˆ ê²°ì œ -->
			<div id="cashArea" th:if="${paymentMethod == 'cash'}"
				style="display: flex; flex-direction: column;">
				<div id="cashWarning" class="bad-text">ä¸è¶³é‡‘é¡: 0å††</div>
				<input type="number" id="cashInput" class="input-cash"
					placeholder="æŠ•å…¥é‡‘é¡ (Â¥)" min="0" inputmode="numeric">
				<button id="cashPayBtn" class="k-btn" disabled>æ”¯æ‰•ã†</button>
			</div>

			<!-- ì¹´ë“œ ê²°ì œ -->
			<div id="cardArea" th:if="${paymentMethod == 'card'}"
				style="display: flex; flex-direction: column;">
				<div id="cardProcess" class="process-box" style="display: none;">
					<div class="spinner"></div>
					<div class="proc-text" id="procText">ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦</div>
				</div>
				<button id="cardPayBtn" class="k-btn">æ”¯æ‰•ã†</button>
			</div>

			<!-- Step5 ì´ë™ìš© í¼ (â˜… tx ì „ë‹¬ í¬í•¨ ë²„ì „) -->
			<form id="toStep5" th:action="@{/kiosk/step5}" method="post"
				style="display: none;">
				<input type="hidden" name="carId" th:value="${carId}"> <input
					type="hidden" name="amountYen" th:value="${totalFee}"> <input
					type="hidden" name="paymentMethod" th:value="${paymentMethod}">
				<input type="hidden" name="tenderedYen" id="tenderedYen"> <input
					type="hidden" name="changeYen" id="changeYen">
				<!-- â˜… tx ì „ë‹¬ (ìˆì„ ë•Œë§Œ) -->
				<input type="hidden" name="tx" th:if="${tx != null}"
					th:value="${tx}">
			</form>
		</section>
	</main>

	<script>
(function(){
  /* ===== i18n ===== */
  let lang = localStorage.getItem('kiosk_lang') || 'ja';
  const t = {
    ja:{
      title:'ãŠæ”¯æ‰•ã„', home:'ãƒ›ãƒ¼ãƒ ', back:'â† æˆ»ã‚‹', lang:'English',
      hSummary:'ã”åˆ©ç”¨å†…å®¹', lblEntry:'å…¥åº«æ™‚åˆ»ï¼š', lblExit:'å‡ºåº«æ™‚åˆ»ï¼š', lblUse:'åˆ©ç”¨æ™‚é–“ï¼š',
      lblFree:'ç„¡æ–™é§è»Šæ™‚é–“ï¼š', lblTotal:'åˆ©ç”¨æ–™é‡‘ï¼š', lblMethod:'æ”¯æ‰•æ–¹æ³•ï¼š',
      cardMent:'ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã€æ¡ˆå†…ã«å¾“ã£ã¦ãã ã•ã„ã€‚', hPayCash:'ç¾é‡‘æ”¯æ‰•ã„', hPayCard:'ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ',
      amtPrefix:'ãŠæ”¯æ‰•ã„é‡‘é¡ï¼š', cashPlaceholder:'æŠ•å…¥é‡‘é¡ (Â¥)', pay:'æ”¯æ‰•ã†', lack:'ä¸è¶³é‡‘é¡: '
    },
    en:{
      title:'Payment', home:'Home', back:'â† Back', lang:'æ—¥æœ¬èª',
      hSummary:'Usage details', lblEntry:'Entry time:', lblExit:'Exit time:', lblUse:'Usage time:',
      lblFree:'Free time:', lblTotal:'Amount due:', lblMethod:'Method:',
      cardMent:'Insert card and follow the instructions.', hPayCash:'Cash payment', hPayCard:'Card payment',
      amtPrefix:'Amount to pay: ', cashPlaceholder:'Cash inserted (Â¥)', pay:'Pay', lack:'Short: '
    }
  };

  function q(id){return document.getElementById(id);}
  const btnLang=q('btnLang'), btnHome=q('btnHome'), btnBack=q('btnBack'), titleText=q('titleText');
  const hSummary=q('hSummary'), hPay=q('hPay'), cardMent=q('cardMent'), amtText=q('amtText');
  const lblEntry=q('lblEntry'), lblExit=q('lblExit'), lblUse=q('lblUse'), lblFree=q('lblFree'), lblTotal=q('lblTotal'), lblMethod=q('lblMethod');
  const cashInput=q('cashInput'), cashPayBtn=q('cashPayBtn'), cashWarning=q('cashWarning');

  function applyLang(){
    const L=t[lang];
    titleText.textContent = L.title;
    btnHome.textContent   = (lang==='ja'?'ğŸ  ':'') + L.home;
    btnBack.textContent   = L.back;
    btnLang.textContent   = L.lang;
    if(hSummary) hSummary.textContent = L.hSummary;
    if(lblEntry)  lblEntry.textContent = L.lblEntry;
    if(lblExit)   lblExit.textContent  = L.lblExit;
    if(lblUse)    lblUse.textContent   = L.lblUse;
    if(lblFree)   lblFree.textContent  = L.lblFree;
    if(lblTotal)  lblTotal.textContent = L.lblTotal;
    if(lblMethod) lblMethod.textContent= L.lblMethod;
    if(cardMent)  cardMent.textContent = L.cardMent;

    const isCard = !!q('cardArea');
    if(hPay) hPay.textContent = isCard ? L.hPayCard : L.hPayCash;

    const needAmount = parseInt((q('needAmount')?.textContent || '0').replace(/,/g,''),10) || 0;
    if(amtText){
      const num = needAmount.toLocaleString('ja-JP');
      amtText.innerHTML = `${L.amtPrefix}<span>${num}</span>å††`;
    }
    if(cashInput) cashInput.placeholder = L.cashPlaceholder;
    if(cashPayBtn) cashPayBtn.textContent = L.pay;

    if(cashWarning && cashWarning.style.display!=='none'){
      const diffTxt = cashWarning.textContent.replace(/^(.+?:\s*)/, '');
      cashWarning.textContent = L.lack + diffTxt;
    }
  }
  btnLang && (btnLang.onclick=()=>{ lang=(lang==='ja'?'en':'ja'); localStorage.setItem('kiosk_lang',lang); applyLang(); });

  /* ===== ê¸ˆì•¡ ë¡œì§ ===== */
  const needAmountEl = q('needAmount');
  const needAmount = parseInt(needAmountEl ? needAmountEl.textContent.replace(/,/g,'') : '0', 10) || 0;
  const form = q('toStep5'), tenderedYen=q('tenderedYen'), changeYen=q('changeYen');

  if (cashInput){
    cashWarning.style.display = 'none';
    const onCashInput = ()=>{
      const L=t[lang];
      const inserted = parseInt(cashInput.value || '0', 10);
      const diff = needAmount - inserted;
      if(diff > 0){
        cashWarning.style.display = 'block';
        cashWarning.textContent = `${L.lack}${diff.toLocaleString('ja-JP')}å††`;
        q('cashPayBtn').disabled = true;
      }else{
        cashWarning.style.display = 'none';
        q('cashPayBtn').disabled = false;
      }
    };
    cashInput.addEventListener('input', onCashInput);
    q('cashPayBtn')?.addEventListener('click', ()=>{
      const inserted = parseInt(cashInput.value || '0', 10);
      if(inserted < needAmount) return;
      const change = inserted - needAmount;
      if(tenderedYen) tenderedYen.value = inserted;
      if(changeYen)   changeYen.value   = Math.max(0, change);
      form.submit();
    });
  }

  const cardPayBtn  = q('cardPayBtn');
  const cardProcess = q('cardProcess');
  const procText    = q('procText');
  if (cardPayBtn){
    cardPayBtn.addEventListener('click', ()=>{
      cardPayBtn.disabled = true;
      if(cardProcess) cardProcess.style.display = 'flex';
      let step = 0;
      const steps = ['ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦','æ±ºæ¸ˆã‚’å‡¦ç†ã—ã¦ã„ã¾ã™â€¦','æ‰¿èªã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦'];
      const interval = setInterval(()=>{
        step++;
        if(step < steps.length){ procText.textContent = steps[step]; }
        else{ clearInterval(interval); form.submit(); }
      }, 700);
    });
  }

  /* Back ë²„íŠ¼: step3ë¡œ */
  btnBack.onclick = (e)=>{
    if(document.referrer && /\/kiosk\/step3\b/.test(document.referrer) && history.length>1){
      e.preventDefault();
      history.back();
    }
  };

  applyLang();
})();
</script>
</body>
</html>
