<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>äº‹å‰ç²¾ç®—ï½œãŠæ”¯æ‰•ã„</title>
<style>
:root{
  --bg:#fdf5e6; --panel:#fffaf0; --text:#444; --line:#d8c49b;
  --accent:#d6b85a; --hover:#f8efd0; --muted:#666; --danger:#b56576;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;padding:0;}
body{
  background:var(--bg); color:var(--text);
  font-family:'Noto Sans JP','Malgun Gothic',sans-serif;
  display:flex; flex-direction:column;
}
/* ìƒë‹¨ë°” */
.topbar{
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 20px; background:var(--panel); border-bottom:2px solid var(--line);
}
.title{font-weight:800; text-align:center; flex:1;}
.actions{display:flex; gap:10px;}
.link-btn,.k-btn{
  border:2px solid var(--line); border-radius:10px; background:var(--bg);
  color:var(--text); font-weight:700; cursor:pointer;
  transition:background .2s ease, transform .05s ease;
}
.link-btn:hover,.k-btn:hover{ background:var(--hover); }
.link-btn{ padding:8px 12px; font-size:13px; }
.k-btn{ padding:12px 28px; font-size:18px; }
.k-btn:active{ transform:translateY(1px); }
.k-btn--accent{ background:var(--accent); color:#fff; }
.k-btn--accent:hover{ background:#caaa45; }

/* ë ˆì´ì•„ì›ƒ */
.main-wrap{ flex:1; display:grid; gap:16px; padding:16px; grid-template-columns:1fr 1fr; }
@media(max-width:980px){ .main-wrap{ grid-template-columns:1fr; } }
.card{
  background:var(--panel); border:2px solid var(--line); border-radius:12px; padding:20px;
  box-shadow:0 3px 8px rgba(0,0,0,.1);
}
.section-title{ margin:0 0 10px 0; text-align:center; }

/* ìš”ê¸ˆ ìš”ì•½ */
.summary-box{
  background:#fff; border:2px solid var(--line); border-radius:12px; padding:16px; line-height:1.8; font-size:18px;
}
.bad{ color:#b91c1c; font-weight:900; }
.good{ color:#2e7d32; font-weight:900; }

/* í˜„ê¸ˆ ê²°ì œ */
.cash-wrap{ display:grid; grid-template-columns:1fr; gap:16px; }
.cash-display{
  display:grid; gap:10px; background:#fff; border:2px solid var(--line); border-radius:12px; padding:16px;
}
.cash-row{ display:flex; justify-content:space-between; align-items:center; }
.amount{ font-size:22px; font-weight:900; }
.amount input{
  width:160px; font-size:22px; padding:8px;
  border:2px solid var(--line); border-radius:8px; text-align:right;
}
.keypad{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
.k-key{ border:2px solid var(--line); background:var(--bg); border-radius:10px; padding:16px 0; font-size:22px; font-weight:800; cursor:pointer; }
.k-key:hover{ background:var(--hover); }
.k-wide{ grid-column: span 3; }

/* ì¹´ë“œ ê²°ì œ */
.card-wrap{ display:grid; gap:16px; }
.reader{
  height:160px; border:2px dashed var(--line); background:#fff; border-radius:12px;
  display:flex; align-items:center; justify-content:center; font-size:18px; color:var(--muted);
}
.progress{
  height:10px; background:#e9e2cf; border-radius:999px; overflow:hidden; border:1px solid var(--line);
}
.bar{ height:100%; width:0%; background:var(--accent); transition:width .2s linear; }
.center{ text-align:center; }
.muted{ color:var(--muted); font-size:14px; }
</style>
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <div class="topbar">
    <div class="actions"><a href="/kiosk/step1" class="link-btn" id="btnHome">ğŸ  ãƒ›ãƒ¼ãƒ </a></div>
    <div class="title" id="titleText">ãŠæ”¯æ‰•ã„æ–¹æ³•</div>
    <div class="actions"><button type="button" class="link-btn" id="btnLang">English</button></div>
  </div>

  <main class="main-wrap">
    <!-- ì¢Œ: ê²°ì œ ì§„í–‰ íŒ¨ë„ (í˜„ê¸ˆ/ì¹´ë“œ ë¶„ê¸°) -->
    <section class="card">
      <!-- í˜„ê¸ˆ -->
      <div id="cashPanel" class="cash-wrap" style="display:none;">
        <h2 class="section-title" id="cashTitle">ç¾é‡‘ã§ãŠæ”¯æ‰•ã„</h2>

        <div class="cash-display">
          <div class="cash-row">
            <div>ãŠæ”¯æ‰•ã„é‡‘é¡</div>
            <div class="amount"><span id="dueLabel" th:text="${feeDisplay}">Â¥2,000</span></div>
          </div>
          <div class="cash-row">
            <div>æŠ•å…¥é‡‘é¡</div>
            <div class="amount"><span id="insertedLabel">Â¥0</span></div>
          </div>
          <div class="cash-row">
            <div>ä¸è¶³é‡‘é¡</div>
            <div class="amount"><span id="shortLabel" class="bad">Â¥2,000</span></div>
          </div>
          <div class="cash-row">
            <div>å…¥åŠ›é‡‘é¡</div>
            <div class="amount">
              <input id="inputAmount" type="text" inputmode="numeric" placeholder="0" value="0">
            </div>
          </div>
        </div>

        <div class="keypad">
          <button class="k-key" data-k="1">1</button>
          <button class="k-key" data-k="2">2</button>
          <button class="k-key" data-k="3">3</button>
          <button class="k-key" data-k="4">4</button>
          <button class="k-key" data-k="5">5</button>
          <button class="k-key" data-k="6">6</button>
          <button class="k-key" data-k="7">7</button>
          <button class="k-key" data-k="8">8</button>
          <button class="k-key" data-k="9">9</button>
          <button class="k-key" data-k="00">00</button>
          <button class="k-key" data-k="0">0</button>
          <button class="k-key" id="clearKey">CLR</button>
        </div>

        <div class="center">
          <button class="k-btn k-btn--accent" id="btnInsert">æŠ•å…¥ï¼ˆåŠ ç®—ï¼‰</button>
          <p class="muted" id="cashHint">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ã€ŒæŠ•å…¥ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚åˆè¨ˆãŒè¶³ã‚Šãªã„å ´åˆã¯ä¸è¶³åˆ†ãŒèµ¤ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
      </div>

      <!-- ì¹´ë“œ -->
      <div id="cardPanel" class="card-wrap" style="display:none;">
        <h2 class="section-title" id="cardTitle">ã‚«ãƒ¼ãƒ‰ã§ãŠæ”¯æ‰•ã„</h2>
        <div class="reader" id="readerMsg">ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥/ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
        <div class="progress"><div class="bar" id="progressBar"></div></div>
        <div class="center">
          <button class="k-btn k-btn--accent" id="btnRead">ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
          <p class="muted" id="cardHint">èª­ã¿å–ã‚ŠãŒå®Œäº†ã™ã‚‹ã¨è‡ªå‹•çš„ã«å®Œäº†ç”»é¢ã¸é€²ã¿ã¾ã™ã€‚</p>
        </div>
      </div>
    </section>

    <!-- ìš°: ìš”ê¸ˆ ìš”ì•½ -->
    <section class="card">
      <h2 class="section-title" id="sumTitle">ã”åˆ©ç”¨æ˜ç´°</h2>
      <div class="summary-box">
        å…¥åº«æ™‚åˆ»ï¼š<span id="entryTime" th:text="${entryTime}">2025-10-29 13:20</span><br/>
        åˆ©ç”¨æ™‚é–“ï¼š<span id="useTime" th:text="${useTime}">2æ™‚é–“30åˆ†</span><br/>
        é§è»Šæ–™é‡‘ï¼š<span id="feeLabel" th:text="${feeDisplay}">Â¥2,000</span>
      </div>
      <div class="center" style="margin-top:16px;">
        <a href="/kiosk/step3" class="k-btn" id="backBtn">æˆ»ã‚‹</a>
      </div>
    </section>
  </main>

  <!-- ì„œë²„ì—ì„œ ì •ìˆ˜ ê¸ˆì•¡ë„ ë‚´ë ¤ì£¼ë©´ ì½ì–´ì„œ ê³„ì‚° (ì˜ˆ: 2000) -->
  <input type="hidden" id="feeRaw" th:value="${fee}" value="2000"/>

<script>
(function(){
  // ===== ì–¸ì–´ =====
  let lang = localStorage.getItem('kiosk_lang') || 'ja';
  const i18n = {
    ja:{
      title:"ãŠæ”¯æ‰•ã„æ–¹æ³•", home:"ãƒ›ãƒ¼ãƒ ", lang:"English",
      cashTitle:"ç¾é‡‘ã§ãŠæ”¯æ‰•ã„", cashHint:"é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ã€ŒæŠ•å…¥ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚åˆè¨ˆãŒè¶³ã‚Šãªã„å ´åˆã¯ä¸è¶³åˆ†ãŒèµ¤ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
      cardTitle:"ã‚«ãƒ¼ãƒ‰ã§ãŠæ”¯æ‰•ã„", cardAsk:"ã‚«ãƒ¼ãƒ‰ã‚’æŒ¿å…¥/ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„", cardBtn:"ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹", cardHint:"èª­ã¿å–ã‚ŠãŒå®Œäº†ã™ã‚‹ã¨è‡ªå‹•çš„ã«å®Œäº†ç”»é¢ã¸é€²ã¿ã¾ã™ã€‚",
      summary:"ã”åˆ©ç”¨æ˜ç´°", back:"æˆ»ã‚‹", inserted:"æŠ•å…¥é‡‘é¡", shortage:"ä¸è¶³é‡‘é¡",
      paidDone:"ãŠæ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å®Œäº†ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚", reading:"èª­ã¿å–ã‚Šä¸­â€¦"
    },
    en:{
      title:"Payment Method", home:"Home", lang:"æ—¥æœ¬èª",
      cashTitle:"Pay with Cash", cashHint:"Enter an amount and press 'Insert'. If not enough, the shortage is shown in red.",
      cardTitle:"Pay with Card", cardAsk:"Insert or tap your card", cardBtn:"Read Card", cardHint:"You'll be redirected to the completion screen when done.",
      summary:"Summary", back:"Back", inserted:"Inserted", shortage:"Shortage",
      paidDone:"Payment complete. Redirecting to the finish screen.", reading:"Readingâ€¦"
    }
  };
  const $ = (id)=>document.getElementById(id);
  const btnLang = $('btnLang'), btnHome = $('btnHome'), titleText = $('titleText');
  const cashTitle = $('cashTitle'), cashHint = $('cashHint');
  const cardTitle = $('cardTitle'), readerMsg = $('readerMsg'), btnRead = $('btnRead'), cardHint = $('cardHint');
  const sumTitle = $('sumTitle'), backBtn = $('backBtn');

  function applyLang(){
    const t=i18n[lang];
    titleText.textContent=t.title; btnHome.textContent="ğŸ  "+t.home; btnLang.textContent=t.lang;
    cashTitle.textContent=t.cashTitle; cashHint.textContent=t.cashHint;
    cardTitle.textContent=t.cardTitle; readerMsg.textContent=t.cardAsk; btnRead.textContent=t.cardBtn; cardHint.textContent=t.cardHint;
    sumTitle.textContent=t.summary; backBtn.textContent=t.back;
  }
  btnLang.onclick=()=>{ lang=(lang==='ja'?'en':'ja'); localStorage.setItem('kiosk_lang',lang); applyLang(); };
  applyLang();

  // ===== ë¶„ê¸°: method=cash|card =====
  function getQuery(k){ return new URLSearchParams(location.search).get(k); }
  const method = (getQuery('method') || 'cash').toLowerCase();
  const cashPanel = $('cashPanel'), cardPanel = $('cardPanel');
  if(method==='card'){ cardPanel.style.display='grid'; } else { cashPanel.style.display='grid'; }

  // ===== ìš”ê¸ˆ =====
  const feeRaw = parseInt(($('feeRaw').value||'0'),10) || 0;
  let inserted = 0;

  // ===== í˜„ê¸ˆ ë¡œì§ =====
  const inputAmount = $('inputAmount'), insertedLabel=$('insertedLabel'), shortLabel=$('shortLabel');
  const btnInsert = $('btnInsert'), clearKey=$('clearKey');
  function formatYen(n){ return 'Â¥' + (n||0).toLocaleString(); }
  function updateCash(){
    insertedLabel.textContent = formatYen(inserted);
    const shortage = Math.max(0, feeRaw - inserted);
    shortLabel.textContent = formatYen(shortage);
    shortLabel.className = shortage>0 ? 'bad' : 'good';
    if(shortage===0){
      alert(i18n[lang].paidDone);
      setTimeout(()=>{ window.location.href='/kiosk/step5'; }, 1200);
    }
  }
  function normValue(){
    // ìˆ«ìë§Œ ì¶”ì¶œ
    const v = String(inputAmount.value).replace(/[^0-9]/g,'');
    inputAmount.value = v.length? String(parseInt(v,10)) : '0';
  }
  if(method==='cash'){
    document.querySelectorAll('[data-k]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const k = b.getAttribute('data-k');
        inputAmount.value = (inputAmount.value==='0' ? '' : inputAmount.value) + k;
        normValue();
      });
    });
    clearKey.addEventListener('click', ()=>{ inputAmount.value='0'; });
    btnInsert.addEventListener('click', ()=>{
      normValue();
      inserted += parseInt(inputAmount.value||'0',10);
      inputAmount.value='0';
      updateCash();
    });
    updateCash();
  }

  // ===== ì¹´ë“œ ë¡œì§ =====
  if(method==='card'){
    const bar=$('progressBar');
    function simulateRead(){
      readerMsg.textContent = i18n[lang].reading;
      let p=0;
      const t = setInterval(()=>{
        p = Math.min(100, p+5);
        bar.style.width = p + '%';
        if(p>=100){
          clearInterval(t);
          alert(i18n[lang].paidDone);
          setTimeout(()=>{ window.location.href='/kiosk/step5'; }, 1000);
        }
      },120);
    }
    // ìë™ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ (ë˜ëŠ” ë²„íŠ¼ìœ¼ë¡œë„ ì‹œì‘ ê°€ëŠ¥)
    setTimeout(simulateRead, 500);
    btnRead.addEventListener('click', simulateRead);
  }
})();
</script>
</body>
</html>
